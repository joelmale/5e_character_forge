<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Migration Test - 5e Character Forge</title>
  <style>
    body {
      font-family: monospace;
      padding: 20px;
      background: #1a1a1a;
      color: #0f0;
    }
    .log { margin: 5px 0; }
    .success { color: #0f0; }
    .error { color: #f00; }
    .warning { color: #ff0; }
    .info { color: #0af; }
    button {
      margin: 10px 5px;
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h1>Character Migration Test Suite</h1>
  <p>This page tests the database migration from version 2 to version 3.</p>

  <div>
    <button onclick="testMigration()">1. Test Migration (Add Legacy Character)</button>
    <button onclick="viewCharacters()">2. View All Characters</button>
    <button onclick="clearDatabase()">3. Clear Database</button>
    <button onclick="checkVersion()">4. Check DB Version</button>
  </div>

  <div id="output"></div>

  <script>
    const DB_NAME = '5e_character_forge';
    const STORE_NAME = 'characters';

    function log(message, type = 'info') {
      const output = document.getElementById('output');
      const div = document.createElement('div');
      div.className = `log ${type}`;
      div.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      output.appendChild(div);
    }

    function checkVersion() {
      const request = indexedDB.open(DB_NAME);

      request.onsuccess = (event) => {
        const db = event.target.result;
        log(`Database version: ${db.version}`, 'info');
        log(`Object stores: ${Array.from(db.objectStoreNames).join(', ')}`, 'info');
        db.close();
      };

      request.onerror = () => {
        log(`Error checking version: ${request.error}`, 'error');
      };
    }

    function testMigration() {
      log('Starting migration test...', 'info');

      // First, we need to simulate a legacy character (version 2)
      // This is tricky because we can't directly insert into an old version
      // So we'll create a character and manually remove the edition field

      const legacyCharacter = {
        id: 'test-migration-' + Date.now(),
        name: 'Legacy Character (Pre-Migration)',
        race: 'Human',
        class: 'Cleric',
        level: 5,
        alignment: 'Neutral Good',
        background: 'Acolyte',
        // NOTE: edition field is intentionally missing for migration test
        inspiration: false,
        proficiencyBonus: 3,
        armorClass: 16,
        hitPoints: 35,
        maxHitPoints: 35,
        hitDice: { current: 5, max: 5, dieType: 8 },
        speed: 30,
        initiative: 0,
        abilities: {
          STR: { score: 10, modifier: 0 },
          DEX: { score: 10, modifier: 0 },
          CON: { score: 14, modifier: 2 },
          INT: { score: 12, modifier: 1 },
          WIS: { score: 16, modifier: 3 },
          CHA: { score: 13, modifier: 1 }
        },
        skills: {
          Acrobatics: { value: 0, proficient: false },
          AnimalHandling: { value: 3, proficient: false },
          Arcana: { value: 1, proficient: false },
          Athletics: { value: 0, proficient: false },
          Deception: { value: 1, proficient: false },
          History: { value: 1, proficient: false },
          Insight: { value: 6, proficient: true },
          Intimidation: { value: 1, proficient: false },
          Investigation: { value: 1, proficient: false },
          Medicine: { value: 6, proficient: true },
          Nature: { value: 1, proficient: false },
          Perception: { value: 3, proficient: false },
          Performance: { value: 1, proficient: false },
          Persuasion: { value: 4, proficient: true },
          Religion: { value: 4, proficient: true },
          SleightOfHand: { value: 0, proficient: false },
          Stealth: { value: 0, proficient: false },
          Survival: { value: 3, proficient: false }
        },
        featuresAndTraits: {
          personality: 'Test character for migration',
          ideals: 'Test',
          bonds: 'Test',
          flaws: 'Test',
          classFeatures: ['Spellcasting', 'Divine Domain'],
          racialTraits: []
        }
      };

      const request = indexedDB.open(DB_NAME);

      request.onsuccess = (event) => {
        const db = event.target.result;
        const transaction = db.transaction([STORE_NAME], 'readwrite');
        const store = transaction.objectStore(STORE_NAME);

        const addRequest = store.add(legacyCharacter);

        addRequest.onsuccess = () => {
          log(`✓ Added legacy character: ${legacyCharacter.name}`, 'success');
          log(`  Character ID: ${legacyCharacter.id}`, 'info');
          log(`  Note: edition field was NOT included`, 'warning');
          log('Now close and reopen the app to trigger migration, or use "View All Characters" to see fallback in action', 'info');
        };

        addRequest.onerror = () => {
          log(`✗ Failed to add legacy character: ${addRequest.error}`, 'error');
        };

        transaction.oncomplete = () => {
          db.close();
        };
      };

      request.onerror = () => {
        log(`✗ Error opening database: ${request.error}`, 'error');
      };
    }

    function viewCharacters() {
      const request = indexedDB.open(DB_NAME);

      request.onsuccess = (event) => {
        const db = event.target.result;
        const transaction = db.transaction([STORE_NAME], 'readonly');
        const store = transaction.objectStore(STORE_NAME);
        const getAllRequest = store.getAll();

        getAllRequest.onsuccess = () => {
          const characters = getAllRequest.result;
          log(`Found ${characters.length} character(s):`, 'info');

          characters.forEach((char, index) => {
            log(`\n--- Character ${index + 1} ---`, 'info');
            log(`  Name: ${char.name}`, 'info');
            log(`  Class: ${char.class} (Level ${char.level})`, 'info');
            log(`  Edition: ${char.edition || 'MISSING ⚠️'}`, char.edition ? 'success' : 'warning');
            if (char.class === 'Cleric' && char.edition === '2024') {
              log(`  Divine Order: ${char.divineOrder || 'N/A'}`, 'info');
            }
          });

          if (characters.length === 0) {
            log('No characters found. Create one using the migration test!', 'warning');
          }
        };

        getAllRequest.onerror = () => {
          log(`✗ Error retrieving characters: ${getAllRequest.error}`, 'error');
        };

        transaction.oncomplete = () => {
          db.close();
        };
      };

      request.onerror = () => {
        log(`✗ Error opening database: ${request.error}`, 'error');
      };
    }

    function clearDatabase() {
      if (!confirm('Are you sure you want to delete ALL characters?')) {
        return;
      }

      const request = indexedDB.deleteDatabase(DB_NAME);

      request.onsuccess = () => {
        log('✓ Database cleared successfully', 'success');
        log('Reload the page or open the app to recreate the database with latest version', 'info');
      };

      request.onerror = () => {
        log(`✗ Error clearing database: ${request.error}`, 'error');
      };

      request.onblocked = () => {
        log('⚠ Database deletion blocked. Close all tabs with the app open.', 'warning');
      };
    }

    // Auto-check version on load
    window.addEventListener('load', () => {
      log('Migration Test Suite Loaded', 'success');
      checkVersion();
    });
  </script>
</body>
</html>
